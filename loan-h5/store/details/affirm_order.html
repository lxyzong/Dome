<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta http-equiv="pragma" content="no-cache">
		<meta http-equiv="cache-control" content="no-cache">
		<link rel="stylesheet" type="text/css" href="../../static/css/common/reset.min.css" />
		<link rel="stylesheet" type="text/css" href="../static/css/affirm_order.css?v=201810226" />
		<title>订单确认</title>
	</head>

	<body>
		<div class="body">
			<div class="site" @click="site()">
				<img src="../static/img/address_line.png" alt="" class="borderImg_A" />
				<div class="site_A display">
					<div class="site1_div">
						<img src="../static/img/ic_location.png" />
						<span>请选择收件地址和收件人</span>
					</div>
					<div>
						<img src="../static/img/right.png" />
					</div>
				</div>
				<div class="site_B display" style="display: none;">
					<span class="userAddressId" v-text="userAddressId" style="display: none;"></span>
					<div>
						<p><span style="margin-right: 0.2rem;" class="receiveName" v-text="receiveName"></span><span class="receivePhone" v-text="receivePhone"></span></p>
						<p><span class="tag" v-show="tag" v-text="tag"></span><span class="receiveDetail" v-text="receiveDetail"></span></p>
					</div>
					<div>
						<img src="../static/img/right.png" />
					</div>
				</div>
				<img src="../static/img/address_line.png" alt="" class="borderImg_B" />
			</div>
			<div class="order_num">
				<span>订单编号：</span><span></span>
			</div>
			<div class="details">
				<li class="display">
					<div>
						<img :src="productDetail.productImg" />
					</div>
					<div class="display">
						<p v-text="productDetail.productName"></p>
						<p></p>
						<p class="display money_discount" v-if="!productDetail.discountPrice"><span class="money"><b>￥</b><b v-text="money(productDetail.productPrice)"></b></span><span>x1</span></p>
						<p class="display money_product" v-else><span class="money"><b>￥</b><b v-text="money(productDetail.discountPrice)"></b><strike>￥<lable v-text="money(productDetail.productPrice)"></lable></strike></span><span>x1</span></p>
					</div>
				</li>
			</div>
			<ul class="introduce">
				<li>
					<span>商品金额</span><span><b>￥</b><b class="productAmount" v-text="money(productAmount)"></b></span>
				</li>
				<li>
					<span>运费</span><span><b>￥</b><b class="deliveryAmount" v-text="money(deliveryAmount)"></b></span>

				</li>
				<li>
					<span>备注：</span>
					<input type="text" placeholder="点击此处添加备注" />
				</li>
				<li>
					<span>订单总额</span><span>共1件商品，总计：<b>￥</b><b v-text="money(orderAmount)"></b></span>
				</li>
			</ul>
			<div class="buy display">
				<li> 总计：<span><b>￥</b><b class="orderAmount" v-text="money(orderAmount)"></b></span></li>
				<li>
					<button @click="purchase()">提交订单</button>
				</li>
			</div>
			<div id="myModal" style="display:none">
				<img src="../static/img/loading.png">
			</div>
			<div id="div" style="display: none;"></div>
		</div>
	</body>
	<script src="../../static/js/common.js"></script>
	<script src="../../static/js/bridge.js"></script>
	<script src="../../static/js/common/vue.min.js"></script>
	<script src="../../static/js/common/jquery.min.js"></script>
	<script>
		$(function() {
			var token = getToken();
			var domain = apiDomain();
			var webUrl = webDomain();
			var product_id = queryUrlParam("product_id");

			$.ajax({
				type: "post",
				url: domain + "/product_order/order_confirm",
				async: true,
				dataType: 'json',
				data: {
					token: token,
					productId: product_id
				},
				success: function(data) {
					var datr = data.data;
					if(data.status == 2000) {
						new Vue({
							el: '.body',
							data: function() {
								return {
									tag: "",
									userAddressId: "",
									receiveName: "",
									receivePhone: "",
									receiveDetail: "",
									deliveryAmount: datr.deliveryAmount,
									orderAmount: datr.orderAmount,
									productAmount: datr.productAmount,
									productDetail: datr.productDetail
								}
							},
							mounted: function() {
								this.aress();
								window.addEventListener('resize', function() {
									if(document.activeElement.tagName === 'INPUT') {
										document.activeElement.scrollIntoView({
											behavior: "smooth"
										})
									}
								});
							},
							methods: {
								aress: function() {
									if(datr.receiveName == "" || datr.receiveName || datr.receiveName != undefined) {
										if(!$("#div").html()) {
											this.tag = datr.tag;
											this.userAddressId = datr.userAddressId;
											this.receiveName = datr.receiveName;
											this.receivePhone = datr.receivePhone;
											this.receiveDetail = datr.receiveDetail;
										} else {
											addS();
										}
										$(".site_A").hide();
										$(".site_B").show();
									} else {
										$(".site_A").show();
										$(".site_B").hide();
									}
								},
								site: function() {
									//去填写地址
									closeAndOpen(10);
								},
								purchase: function() {
									var token = getToken();
									var remark = $("input").val();
									var userAddressId = $(".userAddressId").html();
									var productAmount = $(".productAmount").html();
									var deliveryAmount = $(".deliveryAmount").html();
									var orderAmount = $(".orderAmount").html();
									if(userAddressId == "") {
										alert("请填写收货地址");
										return
									}
									$.ajax({
										type: "post",
										url: domain + "/product_order/order_submit",
										async: true,
										dataType: "json",
										data: {
											token: token,
											productId: product_id,
											userAddressId: userAddressId,
											remark: remark,
											productAmount: productAmount,
											deliveryAmount: deliveryAmount,
											orderAmount: orderAmount
										},
										beforeSend: function() {
											$('#myModal').show();
										},
										success: function(data) {
											if(data.status == 2000) {
												var token = getToken();
												if(!token) {
													closeAndOpen(1);
													return;
												};
												skipPage(1, webUrl + "store/details/pay.html?orderNo=" + data.data + "&orderAmount=" + orderAmount);
												//												window.location.href = "pay.html?orderNo=" + data.data + "&orderAmount=" + orderAmount;
											} else {
												alert(data.message);
											}
										},
										complete: function() {
											$('#myModal').stop().hide();
										}
									});
								},
								money: function(num) {
									var result = parseFloat(num);
									if(isNaN(result)) {
										return false;
									}
									result = Math.round(num * 100) / 100;
									var s_x = result.toString();
									var pos_decimal = s_x.indexOf('.');
									if(pos_decimal < 0) {
										pos_decimal = s_x.length;
										s_x += '.';
									}
									while(s_x.length <= pos_decimal + 2) {
										s_x += '0';
									}
									return s_x;
								}
							}
						});
					}
				}
			});
		});

		function address(string) {
			try {
				$("#div").text(string);
				addS();
			} catch(e) {
				//TODO handle the exception
			}
		};

		function addS() {
			var str = JSON.parse($("#div").html());
			$(".tag").html(str.tag);
			$(".receiveName").html(str.name);
			$(".userAddressId").html(str.id);
			$(".receivePhone").html(str.phone);
			$(".receiveDetail").html(str.province + str.city + str.district + str.detail);
			if(str.tag){
				$(".tag").show();
			}else{
				$(".tag").hide();
			}
			$(".site_A").hide();
			$(".site_B").show();
		}
	</script>

</html>